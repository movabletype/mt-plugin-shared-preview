<mtapp:setting
   id="use_password">
  <ul class="list-unstyled">
    <li>
      <div class="custom-control custom-checkbox">
        <input type="checkbox" name="use_password" id="use" class="custom-control-input" value="1"<mt:if name="use_password"> checked="checked"</mt:if> />
        <label class="custom-control-label" for="use"><__trans phrase="Use password"></label>
      </div>
    </li>
  </ul>
</mtapp:setting>

<mtapp:setting
    id="password"
    label="<__trans phrase="Password">"
    show_hint="1">
  <mt:loop name="sp_password[]">
  <ul id="sp_password_block<mt:var name="__counter__" escape="html">" class="list-inline">
    <li class="list-inline-item w-25">
      <input type="text" name="sp_password[]" class="form-control" value="<mt:var name="__value__" escape="html">" data-index="<mt:var name="__counter__" escape="html">" />
    </li>
    <li class="list-inline-item delete-password-btn" style="display: none;">
      <button type="button" class="btn btn-default btn-sm delete-password" data-target="#sp_password_block<mt:var name="__counter__" escape="html">"><svg title="Delete" role="img" class="mt-icon mt-icon--sm"><use xlink:href="<$mt:var name="static_uri" escape="html"$>images/sprite.svg#ic_trash"></use></svg><__trans phrase="Delete"></button>
    </li>
  </ul>
  </mt:loop>
  <div>
    <a href="javascript:void(0);" id="add_password" ><__trans phrase="Add Password."></a>
  </div>
</mtapp:setting>

<script type="text/javascript">
jQuery(function($) {
    switchSharedPreviewPasswordField();
    jQuery('button.delete-password').on('click', function () {
        clickDeletePassword(this)
    });

    setPasswordAreaInit();

    jQuery('input[name=use_password]').on('change', function(){
        switchSharedPreviewPasswordField();
    });

    jQuery('#add_password').on('click', function(){
        setPasswordArea();
    });

    function setPasswordAreaInit() {
        var count = jQuery('input[name="sp_password[]"]').length;
        var limit = 5;

        if (count < limit) {
            for (var cnt = 0; cnt < (limit - count); cnt++) {
                setPasswordArea();
            }
        }

        jQuery('ul[id^=sp_password_block]').each(function(index){
            if (index == 0) {
                return true;
            }

            jQuery(this).find('.delete-password-btn').css('display','');

        });

    }

    function setPasswordArea() {
        var copy = jQuery('ul[id^=sp_password_block]').last().clone();
        var count = jQuery('input[name="sp_password[]"]').length;
        var counter = parseInt(copy.find('input').attr('data-index')) + 1;
        var newId = 'sp_password_block' + counter;
        var target = '#' + copy.attr('id');

        copy.attr('id', newId)
        .find('input')
        .attr('name', 'sp_password[]')
        .attr('data-index', counter)
        .val('');

        copy.find('.delete-password').attr('data-target', '#' + newId)
        .on('click', function () {
            clickDeletePassword(this)
        });
        jQuery(target).after(copy);
    }

    function switchSharedPreviewPasswordField() {
        var checkedValue = $('input[name=use_password]:checked').val();
        if (checkedValue == 1) {
            jQuery('#password-field').show();
        } else {
            jQuery('#password-field').hide();
        }
    }

    function clickDeletePassword(event) {
        var target = jQuery(event).attr('data-target');
        var inputName = 'input[name="sp_password[]"]';

        if (jQuery('input[name="sp_password[]"]').length > 1) {
           jQuery(target).remove();
           if (jQuery(inputName).length <= 1) {
               jQuery(inputName).parent().next().css('display','none');
           }
        }
    }

});
</script>
